<!--
  Module: Ui Server (legacy stub)
  Rôle: version alternative des endpoints serveur exposés à l'UI HtmlService.
  Entrées publiques: ui_getDashboard(), ui_getStockPage(), ui_getVentesPage(), ui_getLogsTail(), ui_step3RefreshRefs(), ui_step8RecalcAll(), ui_ingestFast(), ui_getConfig(), ui_saveConfig().
  Dépendances: SpreadsheetApp (Stock, Ventes, Logs), Step3/Step8, Ui_Config (saveConfigValues), Perf helpers éventuels.
  Effets de bord: lit les feuilles, déclenche recalculs, purge caches, renvoie tableaux paginés.
  Pièges: duplication avec Ui_Server.gs/PerfendPoints.gs (risque de divergences), accès cellule par cellule, quotas si pagination élevée.
  MAJ: 2025-09-26 – Codex Audit
-->
/**
 * Ponts serveur pour l'UI (HtmlService SPA)
 * Aucune logique métier nouvelle ici : on appelle les fonctions déjà créées.
 */

// --- LECTURE DONNÉES ---
function ui_getDashboard(){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName('Dashboard');
  if (!sh) return {kpis:[], blocks:{}};
  const last = Math.max(2, sh.getLastRow());
  const kpis = sh.getRange(2,1,last-1,2).getValues().filter(r=>r[0]);
  // Blocs auxiliaires (graphiques). On renvoie juste les tableaux si présents.
  // On les recalcule via buildDashboard côté bouton.
  return {kpis:kpis, blocks:{}};
}

function ui_getStockPage(page, size){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName('Stock');
  const total = sh ? Math.max(0, sh.getLastRow()-1) : 0;
  if (!sh || total===0) return {total:0, rows:[]};
  const start = Math.max(0, (page-1)*size);
  const rows = sh.getRange(2+start,1, Math.min(size,total-start), 15).getValues();
  return {total: total, rows: rows};
}

function ui_getVentesPage(page, size){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName('Ventes');
  const total = sh ? Math.max(0, sh.getLastRow()-1) : 0;
  if (!sh || total===0) return {total:0, rows:[]};
  const start = Math.max(0, (page-1)*size);
  const rows = sh.getRange(2+start,1, Math.min(size,total-start), 10).getValues();
  return {total: total, rows: rows};
}

function ui_getLogsTail(n){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName('Logs');
  if (!sh || sh.getLastRow()<2) return [];
  const last = sh.getLastRow();
  const take = Math.min(n||50, last-1);
  return sh.getRange(last-take+1,1,take,5).getValues();
}

function ui_getConfig(){
  return getKnownConfig ? getKnownConfig() : [];
}

// --- ACTIONS ---
function ui_buildDashboard(){ buildDashboard(); return true; }

function ui_ingestFast(){ ingestAllLabelsFast(); return true; }

function ui_step3RefreshRefs(){ step3RefreshRefs(); return true; }

function ui_step8RecalcAll(){ step8RecalcAll(); return true; }

function ui_saveConfig(rows){ return saveConfigValues(rows); }
