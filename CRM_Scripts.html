<!--
  Module: CRM_Scripts.html
  R√¥le: logique client de l'interface CRM riche (chargement des vues, filtres, analytics).
  Entr√©es publiques: initializeApp(), switchView(), refreshAll(), openQuickAdd(), saveStock(), saveSale(), savePurchase(),
    createBackup(), exportAllData().
  D√©pendances: google.script.run (ui_getDashboard, ui_getStockAll, ui_getVentesAll, ui_getConfig, ui_getLogsTail,
    getPurchasesData, getAnalyticsData, saveConfiguration, createBackup, exportAllData, addStock, addSale, addPurchase,
    generateReport), debounce(), formatters locaux.
  Effets de bord: manipule DOM via innerHTML, g√®re √©tats globaux, d√©clenche alertes toast.
  Pi√®ges: conserver les IDs du DOM, √©viter les charges r√©seau multiples, sanitize n√©cessaires avant injection HTML.
  MAJ: 2025-09-26 ‚Äì Codex Audit
-->
<script>
// ========================= √âtat Global =========================
const state = {
  tab: 'dashboard',
  dash: { data: null, loaded: false },
  stock: {
    data: null,
    loaded: false,
    searchTerm: '',
    filters: { category: '', status: '' }
  },
  ventes: {
    data: null,
    loaded: false,
    searchTerm: '',
    filters: { platform: '', dateFrom: '', dateTo: '' }
  },
  achats: {
    data: null,
    loaded: false,
    searchTerm: '',
    filters: { supplier: '', dateFrom: '', dateTo: '' }
  },
  analytics: {
    data: {},
    loaded: false,
    currentPeriod: '7'
  },
  logs: { data: null, loaded: false },
  config: { data: null, loaded: false }
};

let isLoading = false;
let refreshInProgress = false;

// ========================= Helpers =========================
function escapeHtml(value) {
  return String(value == null ? '' : value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function run(name, ...args) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)[name](...args);
  });
}

function parseNumber(value) {
  if (typeof value === 'number') {
    return Number.isFinite(value) ? value : 0;
  }
  if (!value) {
    return 0;
  }
  const normalized = String(value)
    .replace(/[^0-9,.-]/g, '')
    .replace(/,(?=[^,]*,)/g, '')
    .replace(',', '.');
  const parsed = parseFloat(normalized);
  return Number.isFinite(parsed) ? parsed : 0;
}

function normalizeString(value) {
  return String(value == null ? '')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .trim();
}

function parseDateValue(value) {
  if (!value) {
    return null;
  }
  if (value instanceof Date) {
    return value;
  }
  if (typeof value === 'number') {
    // Conversion Google Sheets (jours depuis 1899-12-30)
    const ms = (value - 25569) * 86400 * 1000;
    const date = new Date(ms);
    return Number.isNaN(date.getTime()) ? null : date;
  }
  const parsed = new Date(value);
  return Number.isNaN(parsed.getTime()) ? null : parsed;
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR'
  }).format(amount || 0);
}

function formatPercentage(value) {
  return (value || 0).toFixed(1) + '%';
}

function formatDate(value) {
  if (!value) return '';
  const date = value instanceof Date ? value : new Date(value);
  return Number.isNaN(date.getTime()) ? '' : date.toLocaleDateString('fr-FR');
}

function getActivityIcon(type) {
  const icons = {
    sale: 'üí∞',
    purchase: 'üõí',
    stock: 'üì¶',
    default: 'üìã'
  };
  return icons[type] || icons.default;
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ========================= Initialisation =========================
document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
});

async function initializeApp() {
  console.log('üöÄ Initialisation du CRM (SPA cache)...');
  setupEventListeners();
  await bootstrapApp();
}

async function bootstrapApp() {
  try {
    showLoading();
    const bundle = await fetchAllData();
    applyDataBundle(bundle);
    hideLoading();
    switchView('dashboard');
  } catch (error) {
    hideLoading();
    console.error('Erreur lors de l\'initialisation', error);
    showError('Impossible de charger les donn√©es initiales.');
  }
}

function getAnalyticsPeriods() {
  const select = document.getElementById('analytics-period');
  if (!select) {
    return ['7', '30', '90', '365'];
  }
  const values = Array.from(select.options)
    .map(option => option.value || option.textContent || '')
    .map(value => value.trim())
    .filter(Boolean);
  if (!values.length) {
    return ['7', '30', '90', '365'];
  }
  return Array.from(new Set(values));
}

async function fetchAllData() {
  const analyticsPeriods = getAnalyticsPeriods();

  const [dashboard, stockAll, ventesAll, stockLegacy, purchases, analyticsResults, config, logs] = await Promise.all([
    run('ui_getDashboard'),
    run('ui_getStockAll'),
    run('ui_getVentesAll'),
    run('getStockData').catch(error => {
      console.warn('Chargement getStockData √©chou√©, fallback sur ui_getStockAll', error);
      return null;
    }),
    run('getPurchasesData').catch(error => {
      console.warn('Chargement des achats √©chou√©', error);
      return { purchases: [] };
    }),
    Promise.all(
      analyticsPeriods.map(period =>
        run('getAnalyticsData', period).catch(error => {
          console.warn(`Chargement analytics (${period}) √©chou√©`, error);
          return { topItems: [] };
        })
      )
    ),
    run('ui_getConfig').catch(error => {
      console.warn('Chargement config √©chou√©', error);
      return null;
    }),
    run('ui_getLogsTail', 50).catch(error => {
      console.warn('Chargement logs √©chou√©', error);
      return [];
    })
  ]);

  return {
    dashboard,
    stockAll,
    ventesAll,
    stockLegacy,
    purchases,
    analyticsPeriods,
    analyticsResults,
    config,
    logs
  };
}

function applyDataBundle(bundle) {
  const stockData = mapStockData(bundle.stockAll, bundle.stockLegacy);
  state.stock.data = stockData;
  state.stock.loaded = true;

  const salesData = mapSalesData(bundle.ventesAll);
  state.ventes.data = salesData;
  state.ventes.loaded = true;

  const purchasesData = mapPurchasesData(bundle.purchases);
  state.achats.data = purchasesData;
  state.achats.loaded = true;

  const analyticsData = mapAnalyticsData(bundle.analyticsPeriods, bundle.analyticsResults);
  state.analytics.data = analyticsData;
  state.analytics.loaded = true;
  if (!state.analytics.currentPeriod && bundle.analyticsPeriods.length) {
    state.analytics.currentPeriod = bundle.analyticsPeriods[0];
  }

  state.dash.data = mapDashboardData(bundle.dashboard, stockData, salesData, purchasesData);
  state.dash.loaded = true;

  state.logs.data = Array.isArray(bundle.logs) ? bundle.logs : [];
  state.logs.loaded = true;

  state.config.data = bundle.config;
  state.config.loaded = true;
}

// ========================= Navigation =========================
function switchView(viewName) {
  state.tab = viewName;

  document.querySelectorAll('.view').forEach(view => {
    view.classList.toggle('active', view.id === `${viewName}-view`);
  });

  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.view === viewName);
  });

  if (viewName === 'dashboard') {
    renderDashboard(state.dash.data);
  } else if (viewName === 'stock') {
    renderStock(state.stock.data);
  } else if (viewName === 'ventes') {
    renderSales(state.ventes.data);
  } else if (viewName === 'achats') {
    renderPurchases(state.achats.data);
  } else if (viewName === 'analytics') {
    renderAnalytics(state.analytics.data);
  }
}

// ========================= Refresh Global =========================
async function refreshAll() {
  if (refreshInProgress) {
    return;
  }
  refreshInProgress = true;

  const refreshButton = document.getElementById('btnRefresh');
  if (refreshButton) {
    refreshButton.disabled = true;
  }

  try {
    showLoading();
    const bundle = await fetchAllData();
    applyDataBundle(bundle);
    switchView(state.tab);
  } catch (error) {
    console.error('Erreur refreshAll', error);
    showError('Impossible de rafra√Æchir les donn√©es.');
  } finally {
    hideLoading();
    refreshInProgress = false;
    if (refreshButton) {
      refreshButton.disabled = false;
    }
  }
}

function refreshData() {
  return refreshAll();
}

// ========================= Rendu des vues =========================
function renderDashboard(data) {
  if (!data) {
    document.getElementById('total-revenue').textContent = formatCurrency(0);
    document.getElementById('total-stock').textContent = '0';
    document.getElementById('total-sales').textContent = '0';
    document.getElementById('avg-margin').textContent = formatPercentage(0);
    renderRecentActivity([]);
    return;
  }

  document.getElementById('total-revenue').textContent = formatCurrency(data.totalRevenue || 0);
  document.getElementById('total-stock').textContent = data.totalStock || 0;
  document.getElementById('total-sales').textContent = data.totalSales || 0;
  document.getElementById('avg-margin').textContent = formatPercentage(data.avgMargin || 0);
  renderRecentActivity(data.recentActivity || []);
}

function renderRecentActivity(activities) {
  const container = document.getElementById('recent-activity');
  if (!container) {
    return;
  }

  if (!activities.length) {
    container.innerHTML = '<div class="text-center text-secondary">Aucune activit√© r√©cente</div>';
    return;
  }

  const html = activities.map(activity => `
    <div class="activity-item">
      <div class="activity-icon">${escapeHtml(getActivityIcon(activity.type))}</div>
      <div class="activity-content">
        <div class="activity-title">${escapeHtml(activity.title)}</div>
        <div class="activity-time">${escapeHtml(formatDate(activity.date))}</div>
      </div>
    </div>
  `).join('');

  container.innerHTML = html;
}

function renderStock(data) {
  const tbody = document.querySelector('#stock-table tbody');
  if (!tbody) {
    return;
  }

  if (!data || !Array.isArray(data.items)) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune donn√©e disponible</td></tr>';
    return;
  }

  const filters = state.stock.filters;
  const search = (state.stock.searchTerm || '').trim().toLowerCase();

  const filteredItems = data.items.filter(item => {
    if (filters.category && normalizeString(item.category) !== normalizeString(filters.category)) {
      return false;
    }
    if (filters.status && normalizeString(item.status) !== normalizeString(filters.status)) {
      return false;
    }
    if (search) {
      const haystack = [item.sku, item.title, item.category, item.status, item.platform, item.notes]
        .map(value => normalizeString(value))
        .join(' ');
      if (!haystack.includes(search)) {
        return false;
      }
    }
    return true;
  });

  if (!filteredItems.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucun article correspondant</td></tr>';
  } else {
    const html = filteredItems.map(item => `
      <tr>
        <td><strong>${escapeHtml(item.sku)}</strong></td>
        <td>${escapeHtml(item.title)}</td>
        <td>${escapeHtml(item.category)}</td>
        <td>${escapeHtml(formatCurrency(item.purchasePrice))}</td>
        <td>${escapeHtml(formatCurrency(item.targetPrice))}</td>
        <td><span class="status-badge status-${escapeHtml(normalizeString(item.status) || 'disponible')}">${escapeHtml(item.status || '')}</span></td>
        <td>
          <div class="action-buttons">
            <button class="action-btn action-btn-edit" onclick="editStock('${escapeHtml(String(item.id))}')">‚úèÔ∏è</button>
            <button class="action-btn action-btn-delete" onclick="deleteStock('${escapeHtml(String(item.id))}')">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `).join('');
    tbody.innerHTML = html;
  }

  updateStockFilters(data.items);
}

function updateStockFilters(items) {
  const categorySelect = document.getElementById('stock-category');
  if (!categorySelect) {
    return;
  }

  const categories = Array.from(new Set(
    items
      .map(item => item.category)
      .filter(Boolean)
      .map(category => category.trim())
  )).sort((a, b) => a.localeCompare(b));

  const previousValue = state.stock.filters.category || '';
  categorySelect.innerHTML = '<option value="">Toutes les cat√©gories</option>' +
    categories.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
  categorySelect.value = previousValue;
}

function renderSales(data) {
  const tbody = document.querySelector('#sales-table tbody');
  if (!tbody) {
    return;
  }

  if (!data || !Array.isArray(data.sales)) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune donn√©e disponible</td></tr>';
    return;
  }

  const filters = state.ventes.filters;
  const search = (state.ventes.searchTerm || '').trim().toLowerCase();
  const dateFrom = filters.dateFrom ? parseDateValue(filters.dateFrom) : null;
  const dateTo = filters.dateTo ? parseDateValue(filters.dateTo) : null;

  const filteredSales = data.sales.filter(sale => {
    if (filters.platform && normalizeString(sale.platform) !== normalizeString(filters.platform)) {
      return false;
    }

    const saleDate = parseDateValue(sale.date);
    if (dateFrom && saleDate && saleDate < dateFrom) {
      return false;
    }
    if (dateTo && saleDate && saleDate > dateTo) {
      return false;
    }

    if (search) {
      const haystack = [sale.platform, sale.title, sale.buyer, sale.sku]
        .map(value => normalizeString(value))
        .join(' ');
      if (!haystack.includes(search)) {
        return false;
      }
    }

    return true;
  });

  if (!filteredSales.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune vente correspondante</td></tr>';
  } else {
    const html = filteredSales.map(sale => `
      <tr>
        <td>${escapeHtml(formatDate(sale.date))}</td>
        <td>${escapeHtml(sale.platform)}</td>
        <td>${escapeHtml(sale.title)}</td>
        <td>${escapeHtml(formatCurrency(sale.price))}</td>
        <td>${escapeHtml(formatCurrency(sale.fees))}</td>
        <td class="${escapeHtml(sale.margin >= 0 ? 'text-success' : 'text-danger')}">${escapeHtml(formatCurrency(sale.margin))}</td>
        <td>
          <div class="action-buttons">
            <button class="action-btn action-btn-edit" onclick="editSale('${escapeHtml(String(sale.id))}')">‚úèÔ∏è</button>
            <button class="action-btn action-btn-delete" onclick="deleteSale('${escapeHtml(String(sale.id))}')">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `).join('');
    tbody.innerHTML = html;
  }

  updateSalesFilters(data.sales);
}

function updateSalesFilters(sales) {
  const platformSelect = document.getElementById('sales-platform');
  if (!platformSelect) {
    return;
  }

  const platforms = Array.from(new Set(
    sales
      .map(sale => sale.platform)
      .filter(Boolean)
      .map(platform => platform.trim())
  )).sort((a, b) => a.localeCompare(b));

  const previousValue = state.ventes.filters.platform || '';
  platformSelect.innerHTML = '<option value="">Toutes les plateformes</option>' +
    platforms.map(platform => `<option value="${escapeHtml(platform)}">${escapeHtml(platform)}</option>`).join('');
  platformSelect.value = previousValue;
}

function renderPurchases(data) {
  const tbody = document.querySelector('#purchases-table tbody');
  if (!tbody) {
    return;
  }

  if (!data || !Array.isArray(data.purchases)) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune donn√©e disponible</td></tr>';
    return;
  }

  const filters = state.achats.filters;
  const search = (state.achats.searchTerm || '').trim().toLowerCase();
  const dateFrom = filters.dateFrom ? parseDateValue(filters.dateFrom) : null;
  const dateTo = filters.dateTo ? parseDateValue(filters.dateTo) : null;

  const filteredPurchases = data.purchases.filter(purchase => {
    if (filters.supplier && normalizeString(purchase.supplier) !== normalizeString(filters.supplier)) {
      return false;
    }

    const purchaseDate = parseDateValue(purchase.date);
    if (dateFrom && purchaseDate && purchaseDate < dateFrom) {
      return false;
    }
    if (dateTo && purchaseDate && purchaseDate > dateTo) {
      return false;
    }

    if (search) {
      const haystack = [purchase.supplier, purchase.description, purchase.category, purchase.notes]
        .map(value => normalizeString(value))
        .join(' ');
      if (!haystack.includes(search)) {
        return false;
      }
    }

    return true;
  });

  if (!filteredPurchases.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucun achat correspondant</td></tr>';
  } else {
    const html = filteredPurchases.map(purchase => `
      <tr>
        <td>${escapeHtml(formatDate(purchase.date))}</td>
        <td>${escapeHtml(purchase.supplier)}</td>
        <td>${escapeHtml(purchase.description)}</td>
        <td>${escapeHtml(formatCurrency(purchase.price))}</td>
        <td>${escapeHtml(purchase.category)}</td>
        <td><span class="status-badge status-${escapeHtml(normalizeString(purchase.status) || 'recu')}">${escapeHtml(purchase.status || '')}</span></td>
        <td>
          <div class="action-buttons">
            <button class="action-btn action-btn-edit" onclick="editPurchase('${escapeHtml(String(purchase.id))}')">‚úèÔ∏è</button>
            <button class="action-btn action-btn-delete" onclick="deletePurchase('${escapeHtml(String(purchase.id))}')">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `).join('');
    tbody.innerHTML = html;
  }

  updatePurchasesFilters(data.purchases);
}

function updatePurchasesFilters(purchases) {
  const supplierSelect = document.getElementById('purchases-supplier');
  if (!supplierSelect) {
    return;
  }

  const suppliers = Array.from(new Set(
    purchases
      .map(purchase => purchase.supplier)
      .filter(Boolean)
      .map(supplier => supplier.trim())
  )).sort((a, b) => a.localeCompare(b));

  const previousValue = state.achats.filters.supplier || '';
  supplierSelect.innerHTML = '<option value="">Tous les fournisseurs</option>' +
    suppliers.map(supplier => `<option value="${escapeHtml(supplier)}">${escapeHtml(supplier)}</option>`).join('');
  supplierSelect.value = previousValue;
}

function renderAnalytics(data) {
  const periodSelect = document.getElementById('analytics-period');
  if (periodSelect) {
    const wanted = state.analytics.currentPeriod || periodSelect.value;
    if (wanted) {
      periodSelect.value = wanted;
    }
  }

  const currentPeriod = state.analytics.currentPeriod;
  const dataset = data && currentPeriod ? data[currentPeriod] : null;
  renderTopItems(dataset || []);
}

function renderTopItems(items) {
  const container = document.getElementById('top-items');
  if (!container) {
    return;
  }

  if (!items.length) {
    container.innerHTML = '<div class="text-center text-secondary">Aucune donn√©e disponible</div>';
    return;
  }

  const html = items.map((item, index) => `
    <div class="activity-item">
      <div class="activity-icon">${escapeHtml(index + 1)}</div>
      <div class="activity-content">
        <div class="activity-title">${escapeHtml(item.title || item.sku || '')}</div>
        <div class="activity-time">${escapeHtml(formatCurrency(item.revenue || 0))} ‚Ä¢ ${escapeHtml(item.sales || 0)} ventes</div>
      </div>
    </div>
  `).join('');

  container.innerHTML = html;
}

// ========================= Mapping des donn√©es =========================
function mapStockData(stockAll, stockLegacy) {
  if (stockLegacy && Array.isArray(stockLegacy.items)) {
    return {
      items: stockLegacy.items.map(item => ({
        id: item.id,
        sku: item.sku,
        title: item.title,
        category: item.category,
        purchasePrice: parseNumber(item.purchasePrice),
        targetPrice: parseNumber(item.targetPrice),
        status: item.status,
        platform: item.platform,
        notes: item.notes
      }))
    };
  }

  const rows = Array.isArray(stockAll?.rows) ? stockAll.rows : [];
  return {
    items: rows.map((row, index) => ({
      id: index + 2,
      sku: row[1] || '',
      title: row[2] || '',
      category: row[4] || '',
      purchasePrice: parseNumber(row[8]),
      targetPrice: parseNumber(row[9] || row[8]),
      status: row[9] || 'disponible',
      platform: row[10] || '',
      notes: row[14] || ''
    }))
  };
}

function mapSalesData(ventesAll) {
  const rows = Array.isArray(ventesAll?.rows) ? ventesAll.rows : [];
  const sales = rows.map((row, index) => ({
    id: index + 2,
    date: parseDateValue(row[0]),
    platform: row[1] || '',
    title: row[2] || '',
    price: parseNumber(row[3]),
    fees: parseNumber(row[4]),
    margin: parseNumber(row[9] != null ? row[9] : row[8]),
    buyer: row[6] || '',
    sku: row[7] || ''
  }));

  sales.sort((a, b) => {
    const da = parseDateValue(a.date) || 0;
    const db = parseDateValue(b.date) || 0;
    return db - da;
  });

  return { sales };
}

function mapPurchasesData(purchases) {
  const list = Array.isArray(purchases?.purchases) ? purchases.purchases : [];
  return {
    purchases: list.map(item => ({
      id: item.id,
      date: parseDateValue(item.date),
      supplier: item.supplier || '',
      description: item.description || '',
      price: parseNumber(item.price),
      category: item.category || '',
      status: item.status || 're√ßu',
      notes: item.notes || ''
    }))
  };
}

function mapAnalyticsData(periods, analyticsResults) {
  const data = {};
  periods.forEach((period, index) => {
    const payload = analyticsResults[index];
    data[period] = Array.isArray(payload?.topItems) ? payload.topItems : [];
  });
  return data;
}

function mapDashboardData(dashboardRaw, stockData, salesData, purchasesData) {
  const kpis = Array.isArray(dashboardRaw?.kpis) ? dashboardRaw.kpis : [];
  const kpiMap = new Map();
  kpis.forEach(([label, value]) => {
    if (!label) {
      return;
    }
    kpiMap.set(normalizeString(label), value);
  });

  const findKpiNumber = (keywords) => {
    for (const [key, value] of kpiMap.entries()) {
      if (keywords.some(keyword => key.includes(keyword))) {
        return parseNumber(value);
      }
    }
    return 0;
  };

  const totalRevenue = findKpiNumber(['chiffre', 'ca', 'revenue']);
  const totalStockKpi = findKpiNumber(['stock']);
  const totalSalesKpi = findKpiNumber(['ventes', 'sales']);
  const avgMarginKpi = findKpiNumber(['marge']);

  const computedStock = Array.isArray(stockData?.items)
    ? stockData.items.filter(item => normalizeString(item.status) !== 'vendu').length
    : 0;
  const computedSalesCount = Array.isArray(salesData?.sales) ? salesData.sales.length : 0;
  const computedRevenue = Array.isArray(salesData?.sales)
    ? salesData.sales.reduce((sum, sale) => sum + parseNumber(sale.price), 0)
    : 0;
  const computedMargin = Array.isArray(salesData?.sales)
    ? salesData.sales.reduce((sum, sale) => sum + parseNumber(sale.margin), 0)
    : 0;

  const avgMarginComputed = computedRevenue > 0 ? (computedMargin / computedRevenue) * 100 : 0;

  const recentActivity = buildRecentActivity(salesData?.sales || [], purchasesData?.purchases || []);

  return {
    totalRevenue: totalRevenue || computedRevenue,
    totalStock: totalStockKpi || computedStock,
    totalSales: totalSalesKpi || computedSalesCount,
    avgMargin: avgMarginKpi || avgMarginComputed,
    recentActivity
  };
}

function buildRecentActivity(sales, purchases) {
  const entries = [];

  sales.forEach(sale => {
    const date = parseDateValue(sale.date);
    if (!date) {
      return;
    }
    entries.push({
      type: 'sale',
      title: `${sale.title || 'Vente'} - ${formatCurrency(parseNumber(sale.price))}`,
      date
    });
  });

  purchases.forEach(purchase => {
    const date = parseDateValue(purchase.date);
    if (!date) {
      return;
    }
    entries.push({
      type: 'purchase',
      title: `${purchase.supplier || 'Achat'} - ${formatCurrency(parseNumber(purchase.price))}`,
      date
    });
  });

  entries.sort((a, b) => (b.date || 0) - (a.date || 0));
  return entries.slice(0, 5);
}

// ========================= √âcouteurs =========================
function setupEventListeners() {
  const stockSearch = document.getElementById('stock-search');
  if (stockSearch) {
    stockSearch.addEventListener('input', debounce(event => {
      state.stock.searchTerm = event.target.value || '';
      renderStock(state.stock.data);
    }, 300));
  }

  const stockCategory = document.getElementById('stock-category');
  if (stockCategory) {
    state.stock.filters.category = stockCategory.value || '';
    stockCategory.addEventListener('change', event => {
      state.stock.filters.category = event.target.value || '';
      renderStock(state.stock.data);
    });
  }

  const stockStatus = document.getElementById('stock-status');
  if (stockStatus) {
    state.stock.filters.status = stockStatus.value || '';
    stockStatus.addEventListener('change', event => {
      state.stock.filters.status = event.target.value || '';
      renderStock(state.stock.data);
    });
  }

  const salesSearch = document.getElementById('sales-search');
  if (salesSearch) {
    salesSearch.addEventListener('input', debounce(event => {
      state.ventes.searchTerm = event.target.value || '';
      renderSales(state.ventes.data);
    }, 300));
  }

  const salesPlatform = document.getElementById('sales-platform');
  if (salesPlatform) {
    state.ventes.filters.platform = salesPlatform.value || '';
    salesPlatform.addEventListener('change', event => {
      state.ventes.filters.platform = event.target.value || '';
      renderSales(state.ventes.data);
    });
  }

  const salesDateFrom = document.getElementById('sales-date-from');
  if (salesDateFrom) {
    salesDateFrom.addEventListener('change', event => {
      state.ventes.filters.dateFrom = event.target.value || '';
      renderSales(state.ventes.data);
    });
  }

  const salesDateTo = document.getElementById('sales-date-to');
  if (salesDateTo) {
    salesDateTo.addEventListener('change', event => {
      state.ventes.filters.dateTo = event.target.value || '';
      renderSales(state.ventes.data);
    });
  }

  const purchasesSearch = document.getElementById('purchases-search');
  if (purchasesSearch) {
    purchasesSearch.addEventListener('input', debounce(event => {
      state.achats.searchTerm = event.target.value || '';
      renderPurchases(state.achats.data);
    }, 300));
  }

  const purchasesSupplier = document.getElementById('purchases-supplier');
  if (purchasesSupplier) {
    state.achats.filters.supplier = purchasesSupplier.value || '';
    purchasesSupplier.addEventListener('change', event => {
      state.achats.filters.supplier = event.target.value || '';
      renderPurchases(state.achats.data);
    });
  }

  const purchasesDateFrom = document.getElementById('purchases-date-from');
  if (purchasesDateFrom) {
    purchasesDateFrom.addEventListener('change', event => {
      state.achats.filters.dateFrom = event.target.value || '';
      renderPurchases(state.achats.data);
    });
  }

  const purchasesDateTo = document.getElementById('purchases-date-to');
  if (purchasesDateTo) {
    purchasesDateTo.addEventListener('change', event => {
      state.achats.filters.dateTo = event.target.value || '';
      renderPurchases(state.achats.data);
    });
  }

  const analyticsPeriod = document.getElementById('analytics-period');
  if (analyticsPeriod) {
    state.analytics.currentPeriod = analyticsPeriod.value || analyticsPeriod.options[0]?.value || '7';
    analyticsPeriod.addEventListener('change', event => {
      state.analytics.currentPeriod = event.target.value || '7';
      renderAnalytics(state.analytics.data);
    });
  }
}

// ========================= Actions rapides =========================
function quickAddStock() {
  showModal('Ajouter un article', getStockForm(), [
    { text: 'Annuler', class: 'btn-outline', action: 'closeModal()' },
    { text: 'Ajouter', class: 'btn-primary', action: 'saveStock()' }
  ]);
}

function quickAddSale() {
  showModal('Nouvelle vente', getSaleForm(), [
    { text: 'Annuler', class: 'btn-outline', action: 'closeModal()' },
    { text: 'Enregistrer', class: 'btn-primary', action: 'saveSale()' }
  ]);
}

function quickAddPurchase() {
  showModal('Nouvel achat', getPurchaseForm(), [
    { text: 'Annuler', class: 'btn-outline', action: 'closeModal()' },
    { text: 'Enregistrer', class: 'btn-primary', action: 'savePurchase()' }
  ]);
}

function addStock() {
  quickAddStock();
}

function addSale() {
  quickAddSale();
}

function addPurchase() {
  quickAddPurchase();
}

// ========================= Formulaires =========================
function getStockForm() {
  return `
    <div class="form-group">
      <label class="form-label">SKU *</label>
      <input type="text" id="stock-sku" class="form-input" placeholder="Ex: A001" required>
    </div>
    <div class="form-group">
      <label class="form-label">Titre *</label>
      <input type="text" id="stock-title" class="form-input" placeholder="Titre de l'article" required>
    </div>
    <div class="form-group">
      <label class="form-label">Cat√©gorie</label>
      <select id="stock-category-input" class="form-select">
        <option value="">S√©lectionner une cat√©gorie</option>
        <option value="V√™tements">V√™tements</option>
        <option value="Chaussures">Chaussures</option>
        <option value="Accessoires">Accessoires</option>
        <option value="Sacs">Sacs</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Prix d'achat</label>
      <input type="number" id="stock-purchase-price" class="form-input" placeholder="0.00" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Prix cible</label>
      <input type="number" id="stock-target-price" class="form-input" placeholder="0.00" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea id="stock-description" class="form-textarea" placeholder="Description de l'article"></textarea>
    </div>
  `;
}

function getSaleForm() {
  return `
    <div class="form-group">
      <label class="form-label">Article (SKU) *</label>
      <input type="text" id="sale-sku" class="form-input" placeholder="SKU de l'article vendu" required>
    </div>
    <div class="form-group">
      <label class="form-label">Plateforme *</label>
      <select id="sale-platform" class="form-select" required>
        <option value="">S√©lectionner une plateforme</option>
        <option value="Vinted">Vinted</option>
        <option value="Vestiaire Collective">Vestiaire Collective</option>
        <option value="eBay">eBay</option>
        <option value="Leboncoin">Leboncoin</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Prix de vente *</label>
      <input type="number" id="sale-price" class="form-input" placeholder="0.00" step="0.01" required>
    </div>
    <div class="form-group">
      <label class="form-label">Frais</label>
      <input type="number" id="sale-fees" class="form-input" placeholder="0.00" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Acheteur</label>
      <input type="text" id="sale-buyer" class="form-input" placeholder="Nom de l'acheteur">
    </div>
    <div class="form-group">
      <label class="form-label">Date de vente</label>
      <input type="date" id="sale-date" class="form-input" value="${escapeHtml(new Date().toISOString().split('T')[0])}">
    </div>
  `;
}

function getPurchaseForm() {
  return `
    <div class="form-group">
      <label class="form-label">Fournisseur *</label>
      <input type="text" id="purchase-supplier" class="form-input" placeholder="Nom du fournisseur" required>
    </div>
    <div class="form-group">
      <label class="form-label">Description *</label>
      <input type="text" id="purchase-description" class="form-input" placeholder="Description de l'achat" required>
    </div>
    <div class="form-group">
      <label class="form-label">Prix d'achat *</label>
      <input type="number" id="purchase-price" class="form-input" placeholder="0.00" step="0.01" required>
    </div>
    <div class="form-group">
      <label class="form-label">Cat√©gorie</label>
      <select id="purchase-category" class="form-select">
        <option value="">S√©lectionner une cat√©gorie</option>
        <option value="V√™tements">V√™tements</option>
        <option value="Chaussures">Chaussures</option>
        <option value="Accessoires">Accessoires</option>
        <option value="Sacs">Sacs</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Date d'achat</label>
      <input type="date" id="purchase-date" class="form-input" value="${escapeHtml(new Date().toISOString().split('T')[0])}">
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <textarea id="purchase-notes" class="form-textarea" placeholder="Notes sur cet achat"></textarea>
    </div>
  `;
}

// ========================= Sauvegarde des donn√©es =========================
function saveStock() {
  const data = {
    sku: document.getElementById('stock-sku').value,
    title: document.getElementById('stock-title').value,
    category: document.getElementById('stock-category-input').value,
    purchasePrice: parseFloat(document.getElementById('stock-purchase-price').value) || 0,
    targetPrice: parseFloat(document.getElementById('stock-target-price').value) || 0,
    description: document.getElementById('stock-description').value
  };

  if (!data.sku || !data.title) {
    showError('Veuillez remplir les champs obligatoires');
    return;
  }

  showLoading();

  google.script.run
    .withSuccessHandler(async function(result) {
      hideLoading();
      if (result.success) {
        closeModal();
        showSuccess('Article ajout√© avec succ√®s');
        await refreshAll();
      } else {
        showError(result.error || 'Erreur lors de l\'ajout');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Erreur: ' + error);
    })
    .addStock(data);
}

function saveSale() {
  const data = {
    sku: document.getElementById('sale-sku').value,
    platform: document.getElementById('sale-platform').value,
    price: parseFloat(document.getElementById('sale-price').value) || 0,
    fees: parseFloat(document.getElementById('sale-fees').value) || 0,
    buyer: document.getElementById('sale-buyer').value,
    date: document.getElementById('sale-date').value
  };

  if (!data.sku || !data.platform || !data.price) {
    showError('Veuillez remplir les champs obligatoires');
    return;
  }

  showLoading();

  google.script.run
    .withSuccessHandler(async function(result) {
      hideLoading();
      if (result.success) {
        closeModal();
        showSuccess('Vente enregistr√©e avec succ√®s');
        await refreshAll();
      } else {
        showError(result.error || 'Erreur lors de l\'enregistrement');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Erreur: ' + error);
    })
    .addSale(data);
}

function savePurchase() {
  const data = {
    supplier: document.getElementById('purchase-supplier').value,
    description: document.getElementById('purchase-description').value,
    price: parseFloat(document.getElementById('purchase-price').value) || 0,
    category: document.getElementById('purchase-category').value,
    date: document.getElementById('purchase-date').value,
    notes: document.getElementById('purchase-notes').value
  };

  if (!data.supplier || !data.description || !data.price) {
    showError('Veuillez remplir les champs obligatoires');
    return;
  }

  showLoading();

  google.script.run
    .withSuccessHandler(async function(result) {
      hideLoading();
      if (result.success) {
        closeModal();
        showSuccess('Achat ajout√© avec succ√®s');
        await refreshAll();
      } else {
        showError(result.error || 'Erreur lors de l\'ajout');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Erreur: ' + error);
    })
    .addPurchase(data);
}

// ========================= Gestion des modals =========================
function showModal(title, body, buttons) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = body;

  const footer = document.getElementById('modal-footer');
  footer.innerHTML = buttons.map(btn =>
    `<button class="btn ${escapeHtml(btn.class)}" onclick="${escapeHtml(btn.action)}">${escapeHtml(btn.text)}</button>`
  ).join('');

  document.getElementById('modal-overlay').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
}

// ========================= Gestion du loading =========================
function showLoading() {
  isLoading = true;
  document.getElementById('loading-overlay').classList.remove('hidden');
}

function hideLoading() {
  isLoading = false;
  document.getElementById('loading-overlay').classList.add('hidden');
}

// ========================= Notifications =========================
function showSuccess(message) {
  alert('‚úÖ ' + message);
}

function showError(message) {
  alert('‚ùå ' + message);
}

// ========================= Actions utilitaires =========================
function editStock(id) {
  console.log('Edit stock:', id);
}

function deleteStock(id) {
  if (confirm('√ätes-vous s√ªr de vouloir supprimer cet article ?')) {
    console.log('Delete stock:', id);
  }
}

function editSale(id) {
  console.log('Edit sale:', id);
}

function deleteSale(id) {
  if (confirm('√ätes-vous s√ªr de vouloir supprimer cette vente ?')) {
    console.log('Delete sale:', id);
  }
}

function editPurchase(id) {
  console.log('Edit purchase:', id);
}

function deletePurchase(id) {
  if (confirm('√ätes-vous s√ªr de vouloir supprimer cet achat ?')) {
    console.log('Delete purchase:', id);
  }
}

function openQuickAdd() {
  switch(state.tab) {
    case 'stock':
      quickAddStock();
      break;
    case 'ventes':
      quickAddSale();
      break;
    case 'achats':
      quickAddPurchase();
      break;
    default:
      quickAddStock();
  }
}

function generateReport() {
  showLoading();

  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        showSuccess('Rapport g√©n√©r√© avec succ√®s');
        if (result.url) {
          window.open(result.url, '_blank');
        }
      } else {
        showError(result.error || 'Erreur lors de la g√©n√©ration du rapport');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Erreur: ' + error);
    })
    .generateReport();
}

// ========================= Export functions =========================
function exportStock() {
  window.open('https://docs.google.com/spreadsheets/d/' + getSpreadsheetId() + '/export?format=xlsx&gid=' + getStockSheetId());
}

function exportSales() {
  window.open('https://docs.google.com/spreadsheets/d/' + getSpreadsheetId() + '/export?format=xlsx&gid=' + getSalesSheetId());
}

function exportPurchases() {
  window.open('https://docs.google.com/spreadsheets/d/' + getSpreadsheetId() + '/export?format=xlsx&gid=' + getPurchasesSheetId());
}

function getSpreadsheetId() {
  return '';
}

function getStockSheetId() {
  return '';
}

function getSalesSheetId() {
  return '';
}

function getPurchasesSheetId() {
  return '';
}
</script>
